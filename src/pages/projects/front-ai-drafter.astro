---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import ResumeLightbox from '../../components/ResumeLightbox.astro';

const BASE_URL = import.meta.env.BASE_URL;
---

<Layout title="Front AI Drafter | Amber Gianvecchio">
  <Header />
  <main>
    <article class="case-study">
      <!-- Hero Section -->
      <section class="case-hero">
        <div class="container">
          <a href={`${BASE_URL}`} class="back-link">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back to Home
          </a>
          <h1>Front AI Drafter</h1>
          <p class="case-subtitle">AI-powered customer support system that automatically categorizes messages and generates contextual email draft replies</p>
          <div class="case-meta">
            <div class="meta-item">
              <span class="meta-label">Role</span>
              <span class="meta-value">Operations & AI Integration</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Accuracy</span>
              <span class="meta-value">98%+ accuracy (categorizer, rejection response, initial agents)</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Scale</span>
              <span class="meta-value">17,000+ messages/year</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Overview -->
      <section class="case-content">
        <div class="container">
          <div class="content-grid">
            <!-- Sticky Sidebar Navigation -->
            <aside class="sidebar-nav" id="sidebarNav">
              <div class="sidebar-nav-inner">
                <div class="sidebar-title">On This Page</div>
                <nav class="sidebar-links">
                  <a href="#overview" class="sidebar-link active" data-section="overview">Overview</a>
                  <a href="#challenge" class="sidebar-link" data-section="challenge">The Challenge</a>
                  <a href="#workflow" class="sidebar-link" data-section="workflow">Development Workflow</a>
                  <a href="#results" class="sidebar-link" data-section="results">Key Results</a>
                  <a href="#technologies" class="sidebar-link" data-section="technologies">Technologies</a>
                  <a href="#lessons" class="sidebar-link" data-section="lessons">Lessons Learned</a>
                </nav>
                <div class="sidebar-actions">
                  <button class="sidebar-action" id="scrollToTop" aria-label="Scroll to top">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M8 3L3 8M8 3L13 8M8 3V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Top</span>
                  </button>
                  <button class="sidebar-action" id="scrollToBottom" aria-label="Scroll to bottom">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M8 13L3 8M8 13L13 8M8 13V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Bottom</span>
                  </button>
                </div>
              </div>
            </aside>

            <div class="content-main">
              <h2 id="overview">Overview</h2>
              <p>
                Built an AI-powered customer support system using OpenAI Agents SDK that automatically categorizes incoming messages and generates contextual email draft replies. The system achieved 98%+ accuracy across the categorizer, rejection response agent, and other initial agents through iterative prompt engineering and comprehensive evaluation workflows.
              </p>
              <p>
                This project covers the full AI development cycle: from initial concept through iterative improvement, testing, and deployment. The workflow integrated multiple tools including Cursor IDE for development, Git for version control, OpenAI Agent Builder for configuration, and Braintrust for evaluation and testing.
              </p>

              <h2 id="challenge">The Challenge</h2>
              <p>
                Managing customer communication at scale required a system that could accurately categorize incoming messages and generate appropriate draft responses. The challenge was building an AI agent system that could:
              </p>
              <ul>
                <li>Accurately categorize diverse customer messages into appropriate categories</li>
                <li>Generate contextually appropriate draft email replies</li>
                <li>Maintain high accuracy through iterative improvement</li>
                <li>Integrate seamlessly into existing customer support workflows</li>
              </ul>

              <h2 id="workflow">Development Workflow</h2>
              <p>
                The project followed a rigorous iterative development cycle that connected multiple tools in a continuous improvement loop. Each step in the workflow builds upon the previous, creating a seamless pipeline from development to deployment.
              </p>

              <!-- Animated Cycle Diagram -->
              <div class="workflow-cycle-container workflow-cycle-top">
                <div class="workflow-cycle" id="workflowCycle">
                  <svg class="workflow-cycle-svg" viewBox="0 0 400 400">
                    <defs>
                      <!-- Gradient for glowing trail -->
                      <linearGradient id="trailGradient" gradientUnits="userSpaceOnUse">
                        <stop offset="0%" stop-color="var(--accent)" stop-opacity="0" />
                        <stop offset="100%" stop-color="var(--accent)" stop-opacity="0.8" />
                      </linearGradient>
                      <!-- Glow filter -->
                      <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge>
                          <feMergeNode in="coloredBlur"/>
                          <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                      </filter>
                    </defs>

                    <!-- Base circular path -->
                    <circle class="workflow-path" cx="200" cy="200" r="150" fill="none" stroke="rgba(255, 255, 255, 0.08)" stroke-width="2" />

                    <!-- Animated glowing trail -->
                    <circle class="workflow-trail" cx="200" cy="200" r="150" fill="none" stroke="url(#trailGradient)" stroke-width="3" stroke-linecap="round" stroke-dasharray="120 824" filter="url(#glow)">
                      <animateTransform
                        attributeName="transform"
                        type="rotate"
                        values="0 200 200;360 200 200"
                        dur="8s"
                        repeatCount="indefinite"
                      />
                    </circle>

                    <!-- Animated indicator dot with glow -->
                    <circle class="workflow-indicator" cx="200" cy="50" r="8" fill="var(--accent)" filter="url(#glow)">
                      <animateTransform
                        attributeName="transform"
                        type="rotate"
                        values="0 200 200;360 200 200"
                        dur="8s"
                        repeatCount="indefinite"
                      />
                    </circle>

                  </svg>

                  <!-- Workflow steps positioned around circle (6 steps evenly spaced at 60 degree intervals) -->
                  <div class="workflow-step-item" data-step="1" style="top: 0; left: 50%; transform: translate(-50%, -100%);">
                    <div class="workflow-step-dot"></div>
                    <div class="workflow-step-label">Identify Issue</div>
                  </div>

                  <div class="workflow-step-item" data-step="2" style="top: 25%; right: 0; transform: translate(50%, -50%);">
                    <div class="workflow-step-dot"></div>
                    <div class="workflow-step-label">Edit in Cursor</div>
                  </div>

                  <div class="workflow-step-item" data-step="3" style="bottom: 25%; right: 0; transform: translate(50%, 50%);">
                    <div class="workflow-step-dot"></div>
                    <div class="workflow-step-label">Git Workflow</div>
                  </div>

                  <div class="workflow-step-item" data-step="4" style="bottom: 0; left: 50%; transform: translate(-50%, 100%);">
                    <div class="workflow-step-dot"></div>
                    <div class="workflow-step-label">Agent Builder Sync</div>
                  </div>

                  <div class="workflow-step-item" data-step="5" style="bottom: 25%; left: 0; transform: translate(-50%, 50%);">
                    <div class="workflow-step-dot"></div>
                    <div class="workflow-step-label">Test in Braintrust</div>
                  </div>

                  <div class="workflow-step-item" data-step="6" style="top: 25%; left: 0; transform: translate(-50%, -50%);">
                    <div class="workflow-step-dot"></div>
                    <div class="workflow-step-label">Review Results</div>
                  </div>
                </div>
              </div>

              <div class="workflow-step">
                <h3>1. Development in Cursor IDE</h3>
                <p>
                  All agent development happens in Cursor IDE. I edit agent prompts, instructions, and configurations in <code>src/agents/agentDefinitions.ts</code>. This file contains all agent definitions including the main categorizer, sub-categorizer, and all specialized agents (positive response, rejection response, and 9 sub-agents for the 'other' category).
                </p>
                <p>
                  Common edits include updating agent instructions/prompts, adding few-shot examples to improve agent behavior, adjusting model settings (reasoning effort, temperature, etc.), and updating guardrails configuration (PII detection, moderation, etc.). Before committing, I test changes using local test scripts like <code>replay-test-messages.ts</code> or <code>test-categorizer-failures.ts</code> to verify the agent behaves as expected with sample inputs.
                </p>
                <div class="workflow-image-gallery" data-count="5" data-tool="Cursor IDE">
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Cursor IDE</span>
                    <img src={`${BASE_URL}images/cursor-dev-1.png`} alt="Cursor IDE workspace showing project structure" />
                    <span class="image-caption">Project structure overview</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Cursor IDE</span>
                    <img src={`${BASE_URL}images/cursor-dev-2.png`} alt="Agent definitions file structure" />
                    <span class="image-caption">Agent definitions file</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Cursor IDE</span>
                    <img src={`${BASE_URL}images/cursor-dev-3.png`} alt="Editing agent instructions" />
                    <span class="image-caption">Editing agent instructions</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Cursor IDE</span>
                    <img src={`${BASE_URL}images/cursor-dev-4.png`} alt="Local test script execution" />
                    <span class="image-caption">Running local tests</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Cursor IDE</span>
                    <img src={`${BASE_URL}images/cursor-dev-5.png`} alt="Categorizer test execution" />
                    <span class="image-caption">Categorizer test results</span>
                  </div>
                </div>
              </div>

              <div class="workflow-step">
                <h3>2. Version Control with Git</h3>
                <p>
                  After testing locally, changes move through a structured Git workflow. I pull the latest from the main branch, install dependencies, build and verify locally, then commit changes with descriptive messages. Pull requests enable code review and automated testing through GitHub Actions, ensuring code quality before merging.
                </p>
                <p>
                  When creating a pull request, Cursor IDE can generate a web link, title, and description to streamline the PR creation process. After review and approval, merging the PR triggers automated deployment via GitHub Actions.
                </p>
                <div class="workflow-image-gallery" data-count="3" data-tool="GitHub">
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">GitHub</span>
                    <img src={`${BASE_URL}images/git-1.png`} alt="Git workflow and commits" />
                    <span class="image-caption">Commit history</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">GitHub</span>
                    <img src={`${BASE_URL}images/git-2.png`} alt="Pull request and code review" />
                    <span class="image-caption">Pull request review</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Cursor IDE</span>
                    <img src={`${BASE_URL}images/git-3.png`} alt="GitHub Actions automated testing" />
                    <span class="image-caption">Automated CI/CD</span>
                  </div>
                </div>
              </div>

              <div class="workflow-step">
                <h3>3. Configuration in OpenAI Agent Builder</h3>
                <p>
                  Agent configurations are managed in OpenAI Agent Builder, allowing for easy adjustment of model settings, instructions, and guardrails. If changes were made in Agent Builder, I export updated agents or verify that code changes are reflected correctly. This ensures configuration matches for Braintrust testing and maintains consistency across the development workflow.
                </p>
                <div class="workflow-image-gallery" data-count="5" data-tool="OpenAI">
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">OpenAI</span>
                    <img src={`${BASE_URL}images/openai-builder-1.png`} alt="OpenAI Agent Builder dashboard" />
                    <span class="image-caption">Agent Builder dashboard</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">OpenAI</span>
                    <img src={`${BASE_URL}images/openai-builder-2.png`} alt="Agent configuration settings" />
                    <span class="image-caption">Configuration settings</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">OpenAI</span>
                    <img src={`${BASE_URL}images/openai-builder-3.png`} alt="Model settings and guardrails" />
                    <span class="image-caption">Model settings</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">OpenAI</span>
                    <img src={`${BASE_URL}images/openai-builder-4.png`} alt="Agent instructions configuration" />
                    <span class="image-caption">Agent instructions</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">OpenAI</span>
                    <img src={`${BASE_URL}images/openai-builder-5.png`} alt="Guardrails and safety settings" />
                    <span class="image-caption">Guardrails setup</span>
                  </div>
                </div>
              </div>

                <div class="workflow-step">
                <h3>4. Testing & Evaluation in Braintrust</h3>
                <p>
                  Braintrust serves as our testing and evaluation platform for validating agent performance before deployment. I use the playground to test agent behavior interactively, configure settings to match Agent Builder, and test different prompts to see how outputs change.
                </p>
                <p>
                  I review detailed traces from agent runs showing how the agent reasoned through responses, tool calls made, step-by-step decision making, and guardrails checks. Manual review of 100-300 traces per iteration ensures quality and accuracy improvements. I test categorization accuracy, verify routing to correct categories, and review draft output quality for tone appropriateness, context understanding, and accuracy of information.
                </p>
                <p>
                  Based on traces, logs, and playground testing, I identify what needs improvement, determine which few-shot examples to add, refine agent instructions, and adjust categorization logic—documenting insights for the next iteration in Cursor.
                </p>
                <div class="workflow-image-gallery" data-count="10" data-tool="Braintrust">
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Braintrust</span>
                    <img src={`${BASE_URL}images/braintrust-1.png`} alt="Braintrust monitoring logs" />
                    <span class="image-caption">Monitoring logs</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Braintrust</span>
                    <img src={`${BASE_URL}images/braintrust-2.png`} alt="Categorization test results" />
                    <span class="image-caption">Test results</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Braintrust</span>
                    <img src={`${BASE_URL}images/braintrust-3.png`} alt="Braintrust dashboard" />
                    <span class="image-caption">Dashboard overview</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Braintrust</span>
                    <img src={`${BASE_URL}images/braintrust-4.png`} alt="Project lab overview" />
                    <span class="image-caption">Project lab</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Braintrust</span>
                    <img src={`${BASE_URL}images/braintrust-5.png`} alt="Playground interface for testing prompts" />
                    <span class="image-caption">Playground testing</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Braintrust</span>
                    <img src={`${BASE_URL}images/braintrust-6.png`} alt="Trace view showing agent reasoning" />
                    <span class="image-caption">Trace view</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Braintrust</span>
                    <img src={`${BASE_URL}images/braintrust-7.png`} alt="Detailed trace analysis" />
                    <span class="image-caption">Trace analysis</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Braintrust</span>
                    <img src={`${BASE_URL}images/braintrust-8.png`} alt="Batch trace review interface" />
                    <span class="image-caption">Batch review</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Braintrust</span>
                    <img src={`${BASE_URL}images/braintrust-9.png`} alt="Multiple traces for accuracy verification" />
                    <span class="image-caption">Accuracy verification</span>
                  </div>
                  <div class="workflow-image-card">
                    <span class="image-tool-badge">Braintrust</span>
                    <img src={`${BASE_URL}images/braintrust-10.png`} alt="Draft output quality review" />
                    <span class="image-caption">Output review</span>
                  </div>
                </div>
              </div>

              <h3>Putting It All Together</h3>
              <p>
                Each iteration follows the same pattern, creating a continuous improvement loop:
              </p>
              <div class="cycle-steps">
                <div class="cycle-step">
                  <strong>1. Identify Need for Improvement</strong>
                  <p>Trigger points include Braintrust traces showing issues, manual review revealing patterns, playground testing showing unexpected behavior, or monitoring logs indicating trends.</p>
                </div>
                <div class="cycle-step">
                  <strong>2. Edit in Cursor</strong>
                  <p>Make code changes, update agent definitions, modify instructions/prompts, add few-shot examples, and test locally using test scripts.</p>
                </div>
                <div class="cycle-step">
                  <strong>3. Commit and Push (Git Workflow)</strong>
                  <p>Pull latest from main, install dependencies, build and verify locally, commit changes, push to remote, and create pull request. GitHub Actions automatically runs tests and deploys.</p>
                </div>
                <div class="cycle-step">
                  <strong>4. Sync with Agent Builder</strong>
                  <p>Export updated agents from Agent Builder if changes were made there, or verify in Agent Builder that code changes are reflected correctly. Review agent settings to ensure configuration matches for Braintrust testing.</p>
                </div>
                <div class="cycle-step">
                  <strong>5. Test in Braintrust</strong>
                  <p>Configure playground with settings from Agent Builder, test agents interactively with sample messages, run test batches to generate traces, and review 100-300 traces manually for accuracy.</p>
                </div>
                <div class="cycle-step">
                  <strong>6. Review Results and Iterate</strong>
                  <p>Analyze Braintrust results, compare before/after performance, and decide: if results are good, mark complete and move to next improvement; if results need work, go back to Step 2 to iterate further.</p>
                </div>
              </div>

              <h2 id="results">Key Results</h2>
              <div class="results-grid">
                <div class="result-card">
                  <div class="result-number">98%+</div>
                  <div class="result-label">Agent Accuracy</div>
                  <p>Achieved across categorizer, rejection response agent, and initial agents through iterative prompt engineering and comprehensive testing</p>
                </div>
                <div class="result-card">
                  <div class="result-number">17,000+</div>
                  <div class="result-label">Messages Processed Annually</div>
                  <p>Scalable system handling high-volume customer communication</p>
                </div>
              </div>
              <div class="results-grid results-grid-single">
                <div class="result-card">
                  <div class="result-number">Continuous</div>
                  <div class="result-label">Iterative Improvement</div>
                  <p>Established workflow for ongoing refinement and optimization</p>
                </div>
              </div>

              <h2 id="technologies">Technologies & Tools</h2>
              <div class="tags-list">
                <span class="tag">OpenAI Agents SDK</span>
                <span class="tag">TypeScript</span>
                <span class="tag">Braintrust</span>
                <span class="tag">Git</span>
                <span class="tag">Cursor IDE</span>
                <span class="tag">OpenAI Agent Builder</span>
                <span class="tag">GitHub Actions</span>
                <span class="tag">Prompt Engineering</span>
              </div>

              <h2 id="lessons">Lessons Learned</h2>
              <p>
                The biggest takeaway: AI systems need a real development workflow, not just prompt tweaking. The iterative cycle of development → testing → evaluation → refinement proved essential for achieving high accuracy. Key learnings included:
              </p>
              <ul>
                <li>The value of comprehensive testing infrastructure for AI systems</li>
                <li>How iterative prompt engineering can dramatically improve accuracy</li>
                <li>The importance of manual trace review in identifying edge cases</li>
                <li>How tool integration enables efficient AI development workflows</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- Navigation -->
      <section class="case-navigation">
        <div class="container">
          <a href={`${BASE_URL}`} class="nav-link">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back to Home
          </a>
        </div>
      </section>
    </article>
  </main>

  <!-- Image Lightbox Modal -->
  <div class="image-lightbox" id="imageLightbox" style="display: none;">
    <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
    <img class="lightbox-image" src="" alt="" />
  </div>

  <ResumeLightbox />
</Layout>

<script>
  // Workflow cycle animation with pulsing nodes
  document.addEventListener('DOMContentLoaded', () => {
    const workflowCycle = document.querySelector('.workflow-cycle');
    const indicator = document.querySelector('.workflow-indicator');
    const trail = document.querySelector('.workflow-trail');
    const stepItems = document.querySelectorAll('.workflow-step-item');

    if (!workflowCycle || !indicator || stepItems.length === 0) return;

    // Get all animateTransform elements
    const indicatorAnim = indicator.querySelector('animateTransform');
    const trailAnim = trail?.querySelector('animateTransform');

    // Pulse nodes as indicator passes
    // Step positions in degrees (starting from top, going clockwise)
    const stepAngles = [0, 60, 120, 180, 240, 300]; // 6 steps at 60° intervals
    const animDuration = 8000; // 8 seconds per rotation
    let startTime = performance.now();
    let isPaused = false;
    let pausedAngle = 0;

    // Pause on hover
    workflowCycle.addEventListener('mouseenter', () => {
      if (indicatorAnim) indicatorAnim.setAttribute('dur', '999999s');
      if (trailAnim) trailAnim.setAttribute('dur', '999999s');
      pausedAngle = ((performance.now() - startTime) / animDuration * 360) % 360;
      isPaused = true;
    });

    workflowCycle.addEventListener('mouseleave', () => {
      if (indicatorAnim) indicatorAnim.setAttribute('dur', '8s');
      if (trailAnim) trailAnim.setAttribute('dur', '8s');
      startTime = performance.now() - (pausedAngle / 360 * animDuration);
      isPaused = false;
    });

    function updatePulsingNodes() {
      if (!isPaused) {
        const elapsed = performance.now() - startTime;
        const currentAngle = (elapsed / animDuration * 360) % 360;

        stepItems.forEach((item, index) => {
          const stepAngle = stepAngles[index];
          // Check if indicator is near this step (within 30 degrees)
          let angleDiff = Math.abs(currentAngle - stepAngle);
          if (angleDiff > 180) angleDiff = 360 - angleDiff;

          const dot = item.querySelector('.workflow-step-dot');
          const label = item.querySelector('.workflow-step-label');

          if (!dot || !label) return;

          if (angleDiff < 30) {
            // Pulse intensity based on proximity
            const intensity = 1 - (angleDiff / 30);
            dot.style.backgroundColor = `rgba(255, 255, 255, ${0.4 + intensity * 0.6})`;
            dot.style.boxShadow = `0 0 ${intensity * 20}px rgba(255, 255, 255, ${intensity * 0.8})`;
            dot.style.transform = `scale(${1 + intensity * 0.4})`;
            // Light up the label too
            label.style.color = `rgba(255, 255, 255, ${0.6 + intensity * 0.4})`;
            label.style.textShadow = `0 0 ${intensity * 12}px rgba(255, 255, 255, ${intensity * 0.6})`;
            label.style.fontWeight = intensity > 0.5 ? '600' : '500';
          } else {
            dot.style.backgroundColor = 'rgba(255, 255, 255, 0.4)';
            dot.style.boxShadow = 'none';
            dot.style.transform = 'scale(1)';
            // Reset label
            label.style.color = '';
            label.style.textShadow = 'none';
            label.style.fontWeight = '';
          }
        });
      }
      requestAnimationFrame(updatePulsingNodes);
    }

    updatePulsingNodes();
  });

  // Sidebar Navigation
  document.addEventListener('DOMContentLoaded', () => {
    const sections = ['overview', 'challenge', 'workflow', 'results', 'technologies', 'lessons'];
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const scrollToTopBtn = document.getElementById('scrollToTop');
    const scrollToBottomBtn = document.getElementById('scrollToBottom');
    let currentSectionIndex = 0;

    // Smooth scroll to section
    const scrollToSection = (sectionId) => {
      const section = document.getElementById(sectionId);
      if (section) {
        const offset = 100; // Offset for fixed header
        const sectionPosition = section.getBoundingClientRect().top + window.pageYOffset - offset;
        window.scrollTo({
          top: sectionPosition,
          behavior: 'smooth'
        });
      }
    };

    // Update active sidebar link
    const updateActiveLink = (sectionId) => {
      sidebarLinks.forEach(link => {
        link.classList.remove('active');
        if (link.dataset.section === sectionId) {
          link.classList.add('active');
        }
      });
    };

    // Detect current section on scroll
    const detectCurrentSection = () => {
      const scrollPosition = window.pageYOffset + window.innerHeight / 3;

      for (let i = sections.length - 1; i >= 0; i--) {
        const section = document.getElementById(sections[i]);
        if (section) {
          const sectionTop = section.offsetTop;
          if (scrollPosition >= sectionTop) {
            currentSectionIndex = i;
            updateActiveLink(sections[i]);
            break;
          }
        }
      }
    };

    // Click handlers for sidebar links
    sidebarLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const sectionId = link.dataset.section;
        scrollToSection(sectionId);
        updateActiveLink(sectionId);
      });
    });

    // Scroll to top button
    if (scrollToTopBtn) {
      scrollToTopBtn.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    }

    // Scroll to bottom button
    if (scrollToBottomBtn) {
      scrollToBottomBtn.addEventListener('click', () => {
        window.scrollTo({
          top: document.documentElement.scrollHeight,
          behavior: 'smooth'
        });
      });
    }

    // Update on scroll
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(detectCurrentSection, 50);
    });

    // Initial setup
    detectCurrentSection();
  });

  // Image Lightbox
  document.addEventListener('DOMContentLoaded', () => {
    const lightbox = document.getElementById('imageLightbox');
    const lightboxImage = lightbox?.querySelector('.lightbox-image');
    const lightboxClose = lightbox?.querySelector('.lightbox-close');
    const imageCards = document.querySelectorAll('.workflow-image-card img');

    if (!lightbox || !lightboxImage) return;

    // Open lightbox when clicking on an image card (works for both desktop and mobile)
    const imageCardContainers = document.querySelectorAll('.workflow-image-card');
    imageCardContainers.forEach((card) => {
      card.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const img = card.querySelector('img');
        if (img) {
          lightboxImage.src = img.src;
          lightboxImage.alt = img.alt || 'Screenshot';
          lightbox.style.display = 'flex';
          document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
      });
    });

    // Close lightbox functions
    const closeLightbox = () => {
      lightbox.style.display = 'none';
      document.body.style.overflow = ''; // Restore scrolling
    };

    // Close on button click
    if (lightboxClose) {
      lightboxClose.addEventListener('click', (e) => {
        e.stopPropagation();
        closeLightbox();
      });
    }

    // Close on background click
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });

    // Close on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && lightbox.style.display === 'flex') {
        closeLightbox();
      }
    });
  });
</script>

<style>
  .case-study {
    padding-top: 80px;
  }

  .case-hero {
    padding: 60px 0 40px;
    background-color: var(--bg-secondary);
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 32px;
    color: var(--text-secondary);
    font-size: 0.9rem;
    transition: color var(--transition-fast);
  }

  .back-link:hover {
    color: var(--text-primary);
  }

  .case-hero h1 {
    margin-bottom: 16px;
    color: var(--text-primary);
  }

  .case-subtitle {
    font-size: 1.25rem;
    color: var(--text-secondary);
    margin-bottom: 40px;
    max-width: 800px;
  }

  .case-meta {
    display: flex;
    gap: 48px;
    flex-wrap: wrap;
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .meta-label {
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .meta-value {
    font-size: 1rem;
    color: var(--text-primary);
    font-weight: 500;
  }

  .case-image-section {
    padding: 60px 0;
    background-color: var(--bg-primary);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Device mockup wrapper for hero image */
  .device-mockup {
    position: relative;
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    padding: 20px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 
                0 0 0 1px rgba(255, 255, 255, 0.05) inset;
    overflow: hidden; /* Prevent content from spilling out */
  }

  .device-mockup::before {
    content: '';
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
  }

  .case-hero-image {
    width: 100%;
    height: auto;
    max-height: 600px; /* Limit height to prevent giant images */
    object-fit: contain; /* Ensure image fits without distortion */
    border-radius: 12px;
    display: block;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  }

  /* Floating card styles for workflow images */
  .workflow-image-card {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border);
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    aspect-ratio: 16 / 10; /* Consistent aspect ratio */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .workflow-image-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 255, 255, 0.1);
    border-color: var(--accent);
  }

  .workflow-image-card:hover .image-caption {
    opacity: 1;
    transform: translateY(0);
  }

  .workflow-image-card img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Fit image within card without cropping */
    display: block;
    border: none;
    margin: 0;
    padding: 8px; /* Add padding so images don't touch edges */
    transition: transform 0.3s ease;
  }

  .workflow-image-card:hover img {
    transform: scale(1.02);
  }

  /* Tool badge - top left corner */
  .image-tool-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    padding: 4px 10px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-primary);
    background-color: rgba(10, 10, 10, 0.85);
    border: 1px solid var(--border);
    border-radius: 4px;
    z-index: 3;
    backdrop-filter: blur(4px);
  }

  /* Caption - bottom of card, shown on hover */
  .image-caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 12px 14px;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-primary);
    background: linear-gradient(transparent, rgba(10, 10, 10, 0.95));
    z-index: 3;
    opacity: 0;
    transform: translateY(4px);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .case-content {
    padding: 80px 0;
  }

  .content-grid {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 60px;
    max-width: 1100px;
    margin: 0 auto;
  }

  /* Sticky Sidebar Navigation */
  .sidebar-nav {
    position: relative;
  }

  .sidebar-nav-inner {
    position: sticky;
    top: 100px;
    padding: 20px 0;
  }

  .sidebar-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 16px;
    padding-left: 12px;
  }

  .sidebar-links {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .sidebar-link {
    display: block;
    padding: 8px 12px;
    font-size: 0.9rem;
    color: var(--text-secondary);
    border-left: 2px solid transparent;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .sidebar-link:hover {
    color: var(--text-primary);
    background-color: rgba(255, 255, 255, 0.03);
  }

  .sidebar-link.active {
    color: var(--accent);
    border-left-color: var(--accent);
    background-color: rgba(255, 255, 255, 0.05);
    font-weight: 500;
  }

  .sidebar-actions {
    display: flex;
    gap: 8px;
    margin-top: 24px;
    padding-left: 12px;
  }

  .sidebar-action {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .sidebar-action:hover {
    color: var(--text-primary);
    background-color: rgba(255, 255, 255, 0.1);
    border-color: var(--accent);
  }

  .sidebar-action svg {
    width: 14px;
    height: 14px;
  }

  .content-main {
    max-width: 800px;
  }

  .content-main h2 {
    margin-top: 48px;
    margin-bottom: 24px;
    color: var(--text-primary);
  }

  .content-main h2:first-child {
    margin-top: 0;
  }

  .content-main h3 {
    margin-top: 32px;
    margin-bottom: 16px;
    color: var(--text-primary);
  }

  .content-main p {
    margin-bottom: 20px;
    line-height: 1.7;
  }

  .content-main ul {
    margin: 20px 0;
    padding-left: 24px;
    color: var(--text-secondary);
  }

  .content-main li {
    margin-bottom: 12px;
    line-height: 1.6;
  }

  .content-main code {
    background-color: var(--bg-secondary);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9em;
    color: var(--accent);
    border: 1px solid var(--border);
  }

  .cycle-steps {
    display: grid;
    gap: 24px;
    margin: 32px 0 80px;
  }

  .cycle-step {
    padding: 24px;
    background-color: var(--bg-secondary);
    border-radius: var(--card-radius);
    border-left: 3px solid var(--accent);
    overflow: hidden;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .cycle-step strong {
    display: block;
    color: var(--accent);
    margin-bottom: 8px;
    font-size: 1.05rem;
  }

  .cycle-step p {
    margin: 0;
    color: var(--text-secondary);
  }

  /* Interactive Workflow Cycle */
  .workflow-cycle-container {
    margin: 80px 0 80px;
    text-align: center;
  }

  .workflow-cycle-container.workflow-cycle-top {
    margin: 40px 0 60px;
  }

  .workflow-cycle {
    position: relative;
    width: 400px;
    height: 400px;
    margin: 0 auto 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .workflow-cycle-svg {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
  }

  .workflow-indicator {
    filter: drop-shadow(0 0 8px var(--accent)) drop-shadow(0 0 16px var(--accent));
  }

  .workflow-trail {
    opacity: 0.9;
  }

  .workflow-step-item {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 2;
  }

  .workflow-step-item:hover {
    z-index: 10;
  }

  .workflow-step-item:hover .workflow-step-dot {
    background-color: var(--accent);
    box-shadow: 0 0 12px var(--accent);
    transform: scale(1.3);
  }

  .workflow-step-item:hover .workflow-step-label {
    color: var(--accent);
    font-weight: 600;
  }

  .workflow-step-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.4);
    border: 2px solid rgba(255, 255, 255, 0.6);
    transition: background-color 0.15s ease, box-shadow 0.15s ease, transform 0.15s ease;
    margin-bottom: 8px;
  }

  .workflow-step-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    white-space: nowrap;
    transition: color 0.15s ease, text-shadow 0.15s ease, font-weight 0.15s ease;
    font-weight: 500;
    background-color: rgba(10, 10, 10, 0.8);
    padding: 2px 6px;
    border-radius: 4px;
    margin-top: 4px;
  }

  .workflow-cycle-description {
    color: var(--text-secondary);
    font-size: 0.95rem;
    max-width: 600px;
    margin: 80px auto 0;
    line-height: 1.6;
    text-align: center;
  }

  /* Pause animation on hover */
  .workflow-cycle:hover .workflow-indicator {
    animation-play-state: paused;
  }

  .workflow-cycle:hover .workflow-indicator animateTransform {
    animation-play-state: paused;
  }

  @media (max-width: 768px) {
    .workflow-cycle-container {
      margin: 40px 0;
    }

    .workflow-cycle-container.workflow-cycle-top {
      margin: 20px 0 40px;
    }

    .workflow-cycle {
      width: 280px;
      height: 280px;
      margin: 80px auto 80px; /* Extra space for labels positioned outside */
    }

    .workflow-step-label {
      font-size: 0.7rem;
      padding: 2px 4px;
    }

    .workflow-step-dot {
      width: 10px;
      height: 10px;
    }

    .workflow-cycle-svg {
      transform: scale(0.7);
      transform-origin: center;
    }
  }

  .workflow-step {
    margin: 40px 0;
    padding: 32px;
    background-color: var(--bg-card);
    border-radius: var(--card-radius);
    border: 1px solid var(--border);
    overflow: hidden; /* Prevent content from overflowing */
    word-wrap: break-word; /* Break long words */
    overflow-wrap: break-word; /* Additional word breaking */
  }

  .workflow-step h3 {
    margin-top: 0;
    margin-bottom: 16px; /* Add spacing */
    color: var(--accent);
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .workflow-step p {
    margin-bottom: 24px; /* Ensure spacing before images */
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto; /* Add hyphenation for better text wrapping */
  }

  .workflow-image {
    width: 100%;
    max-width: 100%; /* Ensure images don't exceed container */
    height: auto;
    margin-top: 24px;
    margin-bottom: 0; /* Remove bottom margin on last image */
    border-radius: 8px;
    border: 1px solid var(--border);
    display: block; /* Prevent inline spacing issues */
  }

  /* Add spacing between multiple images */
  .workflow-image + .workflow-image {
    margin-top: 16px;
  }

  /* Image gallery for multiple screenshots - more structured and cohesive */
  .workflow-image-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
    margin-top: 32px;
    align-items: stretch; /* Make all cards same height */
  }

  /* Specific layouts for different numbers of images */
  .workflow-image-gallery[data-count="3"] {
    grid-template-columns: repeat(3, 1fr);
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
  }

  .workflow-image-gallery[data-count="5"] {
    grid-template-columns: repeat(3, 1fr);
  }

  .workflow-image-gallery[data-count="5"] .workflow-image-card:nth-child(4),
  .workflow-image-gallery[data-count="5"] .workflow-image-card:nth-child(5) {
    grid-column: span 1;
  }

  .workflow-image-gallery[data-count="10"] {
    grid-template-columns: repeat(3, 1fr);
  }

  @media (max-width: 768px) {
    /* Horizontal scroll gallery on mobile */
    .workflow-image-gallery {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      gap: 12px;
      padding-bottom: 12px;
      margin-left: -20px;
      margin-right: -20px;
      padding-left: 20px;
      padding-right: 20px;
      -webkit-overflow-scrolling: touch;
    }

    /* Hide scrollbar but keep functionality */
    .workflow-image-gallery::-webkit-scrollbar {
      display: none;
    }
    .workflow-image-gallery {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .workflow-image-gallery .workflow-image-card {
      flex: 0 0 200px;
      scroll-snap-align: start;
      aspect-ratio: 4 / 3;
    }

    .device-mockup {
      padding: 12px;
    }

    .device-mockup::before {
      width: 40px;
      height: 3px;
    }

    /* On mobile, hide the tool badge to avoid overlap */
    .image-tool-badge {
      display: none;
    }

    /* Show captions on mobile since hover isn't available */
    .image-caption {
      opacity: 1;
      transform: translateY(0);
      padding: 8px 10px;
      font-size: 0.75rem;
      background: linear-gradient(transparent, rgba(10, 10, 10, 0.95));
    }
  }

  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin: 40px 0;
  }

  .results-grid-single {
    display: flex;
    justify-content: center;
    grid-template-columns: none;
  }

  .results-grid-single .result-card {
    max-width: 400px;
    width: 100%;
  }

  .result-card {
    padding: 32px;
    background-color: var(--bg-card);
    border-radius: var(--card-radius);
    border: 1px solid var(--border);
    text-align: center;
    overflow: hidden;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .result-number {
    font-size: 2rem; /* Reduced from 2.5rem to fit "Continuous" */
    font-weight: 800;
    color: var(--accent);
    margin-bottom: 8px;
    font-family: var(--font-display);
    white-space: nowrap; /* Keep text on one line */
  }

  .result-label {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 12px;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .result-card p {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin: 24px 0;
  }

  .tag {
    padding: 8px 16px;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-muted);
    background-color: var(--bg-secondary);
    border-radius: 20px;
    border: 1px solid var(--border);
  }

  .case-navigation {
    padding: 60px 0;
    background-color: var(--bg-secondary);
    border-top: 1px solid var(--border);
  }

  .nav-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--accent);
    font-weight: 500;
    transition: gap var(--transition-fast);
  }

  .nav-link:hover {
    gap: 12px;
  }

  /* Image Lightbox Modal */
  .image-lightbox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.95);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    cursor: pointer;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .lightbox-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--text-primary);
    font-size: 28px;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1001;
    backdrop-filter: blur(10px);
  }

  .lightbox-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
    border-color: var(--accent);
    color: var(--accent);
    transform: scale(1.1);
  }

  .lightbox-image {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: zoomIn 0.3s ease;
  }

  @keyframes zoomIn {
    from {
      transform: scale(0.9);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* Tablet breakpoint - sidebar becomes narrower */
  @media (max-width: 1024px) {
    .content-grid {
      grid-template-columns: 180px 1fr;
      gap: 40px;
    }

    .sidebar-link {
      font-size: 0.85rem;
      padding: 6px 10px;
    }

    .sidebar-action {
      padding: 6px 10px;
      font-size: 0.75rem;
    }

    .sidebar-action span {
      display: none;
    }
  }

  @media (max-width: 768px) {
    /* Hide sidebar on mobile */
    .content-grid {
      grid-template-columns: 1fr;
      gap: 0;
    }

    .sidebar-nav {
      display: none;
    }

    .case-meta {
      gap: 24px;
    }

    .workflow-step {
      padding: 24px;
    }

    .results-grid {
      grid-template-columns: 1fr;
    }

    .case-subtitle {
      font-size: 1.1rem;
    }

    .image-lightbox {
      padding: 20px;
    }

    .lightbox-close {
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      font-size: 24px;
    }

    .lightbox-image {
      max-width: 95%;
      max-height: 95%;
    }
  }
</style>

