---
const BASE_URL = import.meta.env.BASE_URL;

// Data from Jan-Jul 2025 (ending at peak)
const data = [
  { month: 'Jan', value: 737 },
  { month: 'Feb', value: 1611 },
  { month: 'Mar', value: 2050 },
  { month: 'Apr', value: 791 },
  { month: 'May', value: 994 },
  { month: 'Jun', value: 1331 },
  { month: 'Jul', value: 3000 },
];

const maxValue = 3200;

// Trend line values (linear regression for Jan-Jul)
const trendStart = 700;
const trendEnd = 2500;
---

<div class="volume-chart-wrapper">
  <div class="chart-header">
    <span class="chart-title">Support Volume Growth</span>
    <span class="chart-subtitle">Messages received per month (Janâ€“Jul 2025)</span>
  </div>

  <div class="chart-container">
    <svg class="volume-chart" viewBox="0 0 600 280" preserveAspectRatio="xMidYMid meet">
      <!-- Grid lines -->
      <g class="grid-lines">
        <line x1="60" y1="40" x2="580" y2="40" />
        <line x1="60" y1="100" x2="580" y2="100" />
        <line x1="60" y1="160" x2="580" y2="160" />
        <line x1="60" y1="220" x2="580" y2="220" />
      </g>

      <!-- Y-axis labels -->
      <g class="y-labels">
        <text x="50" y="44">3,000</text>
        <text x="50" y="104">2,000</text>
        <text x="50" y="164">1,000</text>
        <text x="50" y="224">0</text>
      </g>

      <!-- Area fill -->
      <defs>
        <linearGradient id="areaGradient" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="var(--accent)" stop-opacity="0.3" />
          <stop offset="100%" stop-color="var(--accent)" stop-opacity="0.02" />
        </linearGradient>
      </defs>


      <!-- Trend line (dashed) -->
      <line
        class="trend-line"
        x1="95"
        y1={220 - (trendStart / maxValue) * 180}
        x2={95 + (data.length - 1) * 70}
        y2={220 - (trendEnd / maxValue) * 180}
        stroke="var(--text-muted)"
        stroke-width="2"
        stroke-dasharray="6,4"
        opacity="0.6"
      />

      <!-- Main line -->
      <path class="chart-line" d={`
        M 95 ${220 - (data[0].value / maxValue) * 180}
        ${data.map((d, i) => `L ${95 + i * 70} ${220 - (d.value / maxValue) * 180}`).join(' ')}
      `} fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />

      <!-- Data points -->
      <g class="data-points">
        {data.map((d, i) => (
          <g class="data-point-group">
            <circle
              cx={95 + i * 70}
              cy={220 - (d.value / maxValue) * 180}
              r="5"
              fill="var(--bg-primary)"
              stroke="var(--accent)"
              stroke-width="2"
            />
            <text
              class="point-label"
              x={95 + i * 70}
              y={220 - (d.value / maxValue) * 180 - 12}
              text-anchor="middle"
            >
              {d.value.toLocaleString()}
            </text>
          </g>
        ))}
      </g>

      <!-- X-axis labels -->
      <g class="x-labels">
        {data.map((d, i) => (
          <text x={95 + i * 70} y="250" text-anchor="middle">{d.month}</text>
        ))}
      </g>
    </svg>
  </div>

  <div class="chart-legend">
    <span class="legend-item">
      <span class="legend-line solid"></span>
      Monthly volume
    </span>
    <span class="legend-item">
      <span class="legend-line dashed"></span>
      Growth trend
    </span>
  </div>

  <button class="chart-source" id="openSourceLightbox">
    Source: Front Analytics
  </button>
</div>

<!-- Source Screenshot Lightbox -->
<div class="source-lightbox" id="sourceLightbox" style="display: none;">
  <button class="source-lightbox-close" aria-label="Close">&times;</button>
  <div class="source-lightbox-content">
    <img src={`${BASE_URL}images/operations-dashboard.png`} alt="Front Analytics Dashboard showing workload over time" />
    <p class="source-caption">Front Analytics Dashboard - Workload over time (Jan-Dec 2025)</p>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const openBtn = document.getElementById('openSourceLightbox');
    const lightbox = document.getElementById('sourceLightbox');
    const closeBtn = lightbox?.querySelector('.source-lightbox-close');

    if (!openBtn || !lightbox) return;

    const openLightbox = () => {
      lightbox.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    };

    const closeLightbox = () => {
      lightbox.style.display = 'none';
      document.body.style.overflow = '';
    };

    openBtn.addEventListener('click', openLightbox);
    closeBtn?.addEventListener('click', closeLightbox);

    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && lightbox.style.display === 'flex') {
        closeLightbox();
      }
    });
  });
</script>

<style>
  .volume-chart-wrapper {
    margin: 32px 0;
    padding: 24px;
    background-color: var(--bg-card);
    border-radius: var(--card-radius);
    border: 1px solid var(--border);
  }

  .chart-header {
    margin-bottom: 16px;
  }

  .chart-title {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
  }

  .chart-subtitle {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .chart-container {
    width: 100%;
    overflow: hidden;
  }

  .volume-chart {
    width: 100%;
    height: auto;
    max-height: 260px;
  }

  .grid-lines line {
    stroke: var(--border);
    stroke-width: 1;
  }

  .y-labels text {
    fill: var(--text-muted);
    font-size: 11px;
    text-anchor: end;
  }

  .x-labels text {
    fill: var(--text-secondary);
    font-size: 12px;
    font-weight: 500;
  }

  .chart-line {
    filter: drop-shadow(0 0 6px var(--accent));
  }

  .data-point-group circle {
    transition: r 0.2s ease, filter 0.2s ease;
  }

  .data-point-group:hover circle {
    r: 7;
    filter: drop-shadow(0 0 8px var(--accent));
  }

  .point-label {
    fill: var(--text-secondary);
    font-size: 10px;
    font-weight: 500;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .data-point-group:hover .point-label {
    opacity: 1;
  }

  .growth-label {
    fill: var(--text-muted);
    font-size: 11px;
    font-weight: 500;
  }

  .chart-source {
    display: inline-block;
    margin-top: 12px;
    padding: 0;
    font-size: 0.75rem;
    color: var(--text-muted);
    background: none;
    border: none;
    cursor: pointer;
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.2s ease;
  }

  .chart-source:hover {
    color: var(--accent);
  }

  .chart-legend {
    display: flex;
    gap: 16px;
    margin-top: 12px;
    margin-bottom: 4px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  .legend-line {
    width: 16px;
    height: 2px;
  }

  .legend-line.solid {
    background-color: var(--accent);
  }

  .legend-line.dashed {
    background: repeating-linear-gradient(
      90deg,
      var(--text-muted) 0,
      var(--text-muted) 6px,
      transparent 6px,
      transparent 10px
    );
  }

  /* Source Lightbox */
  .source-lightbox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.95);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    cursor: pointer;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .source-lightbox-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--text-primary);
    font-size: 28px;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1001;
    backdrop-filter: blur(10px);
  }

  .source-lightbox-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
    border-color: var(--accent);
    color: var(--accent);
    transform: scale(1.1);
  }

  .source-lightbox-content {
    max-width: 90%;
    max-height: 90%;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: default;
  }

  .source-lightbox-content img {
    max-width: 100%;
    max-height: calc(90vh - 60px);
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }

  .source-caption {
    margin-top: 16px;
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-align: center;
  }

  @media (max-width: 768px) {
    .volume-chart-wrapper {
      padding: 20px;
      margin: 24px -20px;
      border-radius: 0;
      border-left: none;
      border-right: none;
    }

    .volume-chart {
      max-height: 250px;
    }

    .source-lightbox {
      padding: 20px;
    }

    .source-lightbox-close {
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      font-size: 24px;
    }
  }
</style>
